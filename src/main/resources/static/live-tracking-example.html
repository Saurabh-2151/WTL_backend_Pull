<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTL Live Location Tracking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKjmBSUJ3XR8uD10vG2ptzqLJAZnOlzqI&libraries=places"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .panel h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .status-connecting {
            background: #ffc107;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }

        .log-success {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }

        .log-error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .log-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid #f59e0b;
        }

        .location-display {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .location-display h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .location-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .location-info span {
            font-weight: 600;
            color: #667eea;
        }

        .address-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .address-info strong {
            color: #495057;
        }

        .distance-info {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .proximity-alert {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .otp-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .booking-section {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .booking-display {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .booking-info {
            display: grid;
            gap: 8px;
        }

        .booking-id-display {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .trip-status {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        .connection-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }

        .auto-otp-display {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .auto-otp-display h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .auto-otp-code {
            font-size: 32px;
            font-weight: bold;
            color: #155724;
            letter-spacing: 5px;
            margin: 10px 0;
        }

        .otp-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
        }

        .trip-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .odometer-input {
            font-size: 18px;
            text-align: center;
            font-weight: bold;
        }

        .map-container {
            height: 400px;
            background: #e9ecef;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        #googleMap {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .map-controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 2px;
            cursor: pointer;
            font-size: 12px;
        }

        .map-controls button:hover {
            background: #5a67d8;
        }

        .tracking-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }

        .tracking-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .tracking-info .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .tracking-info .info-label {
            font-weight: 600;
            color: #667eea;
        }

        .tracking-info .info-value {
            color: #495057;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 WTL Live Location Tracking</h1>
            <p>Real-time location tracking with address conversion and distance calculation</p>
        </div>

        <div class="main-content">
            <!-- Live Map Panel -->
            <div class="panel" style="grid-column: 1 / -1;">
                <h2>🗺️ Live Tracking Map</h2>
                <div class="map-container">
                    <div id="googleMap"></div>
                    <div class="map-controls">
                        <button onclick="centerMap()">Center Map</button>
                        <button onclick="toggleTraffic()">Toggle Traffic</button>
                        <button onclick="showRoute()">Show Route</button>
                    </div>
                    <div class="tracking-info">
                        <h4>📍 Live Tracking Info</h4>
                        <div class="info-row">
                            <span class="info-label">Distance:</span>
                            <span class="info-value" id="mapDistance">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ETA:</span>
                            <span class="info-value" id="mapETA">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Direction:</span>
                            <span class="info-value" id="mapDirection">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="mapStatus">Waiting for location...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Panel -->
            <div class="panel">
                <h2>👤 User Panel</h2>
                
                <!-- Booking Creation Section -->
                <div class="booking-section" id="bookingSection">
                    <h3>📅 Create New Booking</h3>
                    
                    <div class="form-group">
                        <label>User ID:</label>
                        <input type="number" id="userId" placeholder="Enter User ID" value="1">
                    </div>

                    <div class="form-group">
                        <label>Pickup Location:</label>
                        <input type="text" id="pickupLocation" placeholder="Enter pickup address">
                    </div>

                    <div class="form-group">
                        <label>Drop Location:</label>
                        <input type="text" id="dropLocation" placeholder="Enter drop address">
                    </div>

                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="bookingDate">
                    </div>

                    <div class="form-group">
                        <label>Time:</label>
                        <input type="time" id="bookingTime">
                    </div>

                    <button class="btn" onclick="createBooking()">Create Booking</button>
                </div>

                <!-- Booking Display Section -->
                <div class="booking-display" id="bookingDisplay" style="display: none;">
                    <h3>🎫 Your Booking</h3>
                    <div class="booking-info">
                        <div class="booking-id-display">
                            <strong>Booking ID:</strong> <span id="generatedBookingId"></span>
                            <button class="btn btn-small" onclick="copyBookingId()">Copy</button>
                        </div>
                        <div><strong>Pickup:</strong> <span id="displayPickup"></span></div>
                        <div><strong>Drop:</strong> <span id="displayDrop"></span></div>
                        <div><strong>Date & Time:</strong> <span id="displayDateTime"></span></div>
                        <div class="trip-status"><strong>Status:</strong> <span id="tripStatus">Waiting for driver</span></div>
                    </div>
                </div>

                <!-- Connection Section -->
                <div class="connection-section">
                    <div class="form-group">
                        <label>Booking ID (for tracking):</label>
                        <input type="text" id="userBookingId" placeholder="Enter Booking ID" value="WTL1234567890">
                    </div>

                    <button class="btn" onclick="connectUserWebSocket()">
                        <span class="status-indicator" id="userStatus"></span>
                        Connect WebSocket
                    </button>

                    <button class="btn" onclick="startUserLocationTracking()">Start Location Tracking</button>
                    <button class="btn" onclick="stopUserLocationTracking()">Stop Location Tracking</button>
                </div>

                <div class="location-display">
                    <h3>📍 Current Location</h3>
                    <div class="location-info">
                        <div>Latitude: <span id="userLat">--</span></div>
                        <div>Longitude: <span id="userLng">--</span></div>
                        <div>Distance to Driver: <span id="userDistance">--</span></div>
                        <div>ETA: <span id="userETA">--</span></div>
                    </div>
                    
                    <div class="address-info" id="userAddress">
                        <strong>Address:</strong> <span id="userAddressText">Loading...</span>
                    </div>
                    
                    <div class="distance-info" id="userDistanceInfo" style="display: none;">
                        <div>Distance: <span id="userDistanceValue">--</span></div>
                        <div>Direction: <span id="userDirection">--</span></div>
                    </div>
                    
                    <div class="proximity-alert" id="userProximityAlert" style="display: none;">
                        🚨 Driver is within 50 meters! Please prepare for pickup.
                    </div>
                </div>

                <!-- Auto-Generated OTP Display -->
                <div class="auto-otp-display" id="autoOtpDisplay" style="display: none;">
                    <h4>🔐 Driver Nearby - OTP Generated!</h4>
                    <div class="auto-otp-code" id="autoGeneratedOtp">------</div>
                    <p>Share this OTP with your driver to start the trip</p>
                </div>

                <!-- Manual OTP Section -->
                <div class="otp-section" id="userOtpSection" style="display: none;">
                    <h3>🔐 OTP Verification</h3>
                    <div class="form-group">
                        <label>Enter OTP:</label>
                        <input type="text" id="userOtpInput" class="otp-input" placeholder="000000" maxlength="6">
                    </div>
                    <button class="btn" onclick="verifyUserOtp()">Verify OTP</button>
                </div>

                <!-- Final OTP for Trip End -->
                <div class="auto-otp-display" id="finalOtpDisplay" style="display: none;">
                    <h4>🏁 Trip End - Final OTP Generated!</h4>
                    <div class="auto-otp-code" id="finalGeneratedOtp">------</div>
                    <p>Share this OTP with your driver to end the trip</p>
                </div>

                <div class="log-container" id="userLog"></div>
            </div>

            <!-- Driver Panel -->
            <div class="panel">
                <h2>🚘 Driver Panel</h2>
                
                <div class="form-group">
                    <label>Driver ID:</label>
                    <input type="number" id="driverId" placeholder="Enter Driver ID" value="1">
                </div>

                <div class="form-group">
                    <label>Booking ID:</label>
                    <input type="text" id="driverBookingId" placeholder="Enter Booking ID" value="WTL1234567890">
                </div>

                <button class="btn" onclick="connectDriverWebSocket()">
                    <span class="status-indicator" id="driverStatus"></span>
                    Connect WebSocket
                </button>

                <button class="btn" onclick="startDriverLocationTracking()">Start Location Tracking</button>
                <button class="btn" onclick="stopDriverLocationTracking()">Stop Location Tracking</button>

                <div class="location-display">
                    <h3>📍 Current Location</h3>
                    <div class="location-info">
                        <div>Latitude: <span id="driverLat">--</span></div>
                        <div>Longitude: <span id="driverLng">--</span></div>
                        <div>Distance to User: <span id="driverDistance">--</span></div>
                        <div>ETA: <span id="driverETA">--</span></div>
                    </div>
                    
                    <div class="address-info" id="driverAddress">
                        <strong>Address:</strong> <span id="driverAddressText">Loading...</span>
                    </div>
                    
                    <div class="distance-info" id="driverDistanceInfo" style="display: none;">
                        <div>Distance: <span id="driverDistanceValue">--</span></div>
                        <div>Direction: <span id="driverDirection">--</span></div>
                    </div>
                    
                    <div class="proximity-alert" id="driverProximityAlert" style="display: none;">
                        🚨 You are within 50 meters of the user! Please contact them.
                    </div>
                </div>

                <!-- Trip Start Section -->
                <div class="otp-section" id="driverOtpSection" style="display: none;">
                    <h3>🔐 Trip Start - Enter User's OTP</h3>
                    <div class="form-group">
                        <label>Enter OTP from User:</label>
                        <input type="text" id="driverOtpInput" class="otp-input" placeholder="000000" maxlength="6">
                    </div>
                    <button class="btn" onclick="verifyDriverOtp()">Verify OTP & Start Trip</button>
                </div>

                <!-- Odometer Section -->
                <div class="trip-controls" id="odometerSection" style="display: none;">
                    <div class="form-group">
                        <label>Start Odometer Reading:</label>
                        <input type="number" id="startOdometer" class="odometer-input" placeholder="Enter reading" step="0.1">
                    </div>
                    <button class="btn" onclick="startTripWithOdometer()">Confirm Start Trip</button>
                </div>

                <!-- Trip End Section -->
                <div class="trip-controls" id="tripEndSection" style="display: none;">
                    <div class="form-group">
                        <label>End Odometer Reading:</label>
                        <input type="number" id="endOdometer" class="odometer-input" placeholder="Enter reading" step="0.1">
                    </div>
                    <button class="btn" onclick="requestFinalOtp()">Request Final OTP</button>
                </div>

                <!-- Final OTP Verification Section -->
                <div class="otp-section" id="driverFinalOtpSection" style="display: none;">
                    <h3>🏁 Trip End - Enter User's Final OTP</h3>
                    <div class="form-group">
                        <label>Enter Final OTP from User:</label>
                        <input type="text" id="driverFinalOtpInput" class="otp-input" placeholder="000000" maxlength="6">
                    </div>
                    <button class="btn" onclick="verifyFinalOtp()">Verify Final OTP & End Trip</button>
                </div>

                <div class="log-container" id="driverLog"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let userStompClient = null;
        let driverStompClient = null;
        let userLocationInterval = null;
        let driverLocationInterval = null;
        let currentUserLocation = null; // Will be set by GPS
        let currentDriverLocation = null; // Will be set by GPS
        let currentBookingId = null;
        let currentOtp = null;
        let finalOtp = null;
        let tripStarted = false;
        let proximityOtpGenerated = false;
        let otpVerifyTimer = null; // timer for OTP verification fallback
        let finalOtpVerifyTimer = null; // timer for Final OTP fallback
        const lastGeocode = { user: { t: 0, addr: '' }, driver: { t: 0, addr: '' } };
        
        // Google Maps variables
        let map = null;
        let userMarker = null;
        let driverMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let trafficLayer = null;
        let isTrafficVisible = false;
        let routePolyline = null;

        // Get current GPS location
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        resolve(location);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        // Fallback to a default location (you can change this to your preferred default)
                        const fallbackLocation = { lat: 18.5204, lng: 73.8567 }; // Pune coordinates
                        resolve(fallbackLocation);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            });
        }

        // Distance calculation function (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Distance in kilometers
            return distance;
        }

        // Calculate direction between two points
        function calculateDirection(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(bearing / 45) % 8;
            return directions[index < 0 ? index + 8 : index];
        }

        // Directions helpers: fetch route metrics and update UI
        function getRouteMetrics(origin, destination) {
            return new Promise((resolve, reject) => {
                if (!directionsService) {
                    reject(new Error('DirectionsService not initialized'));
                    return;
                }
                const request = {
                    origin,
                    destination,
                    travelMode: google.maps.TravelMode.DRIVING
                };
                directionsService.route(request, (result, status) => {
                    if (status === 'OK' && result && result.routes && result.routes[0] && result.routes[0].legs && result.routes[0].legs[0]) {
                        const leg = result.routes[0].legs[0];
                        const distanceKm = (leg.distance && typeof leg.distance.value === 'number') ? (leg.distance.value / 1000) : null;
                        const durationMin = (leg.duration && typeof leg.duration.value === 'number') ? Math.round(leg.duration.value / 60) : null;
                        resolve({ distanceKm, durationMin, result });
                    } else {
                        reject(new Error('Directions request failed: ' + status));
                    }
                });
            });
        }

        async function updateRouteMetricsUI(prefix, origin, destination, renderRoute = false) {
            try {
                const { distanceKm, durationMin, result } = await getRouteMetrics(origin, destination);
                if (typeof distanceKm === 'number') {
                    document.getElementById(`${prefix}Distance`).textContent = `${distanceKm.toFixed(2)} km`;
                    document.getElementById(`${prefix}DistanceValue`).textContent = `${distanceKm.toFixed(2)} km`;
                }
                if (typeof durationMin === 'number') {
                    document.getElementById(`${prefix}ETA`).textContent = `${durationMin} min`;
                }
                document.getElementById(`${prefix}DistanceInfo`).style.display = 'block';
                if (renderRoute && directionsRenderer) {
                    directionsRenderer.setDirections(result);
                }
                return { distanceKm, durationMin };
            } catch (e) {
                // Fallback to straight-line to avoid blank UI if Directions fails
                log(`${prefix}Log`, `Route metrics failed: ${e.message}. Falling back to straight-line.`, 'warning');
                const distance = calculateDistance(origin.lat, origin.lng, destination.lat, destination.lng);
                const etaMinutes = Math.round(distance * 2); // ~30 km/h fallback
                document.getElementById(`${prefix}Distance`).textContent = `${distance.toFixed(2)} km`;
                document.getElementById(`${prefix}DistanceValue`).textContent = `${distance.toFixed(2)} km`;
                document.getElementById(`${prefix}ETA`).textContent = `${etaMinutes} min`;
                document.getElementById(`${prefix}DistanceInfo`).style.display = 'block';
                return { distanceKm: distance, durationMin: etaMinutes };
            }
        }

        // Reverse geocoding function
        async function getAddressFromCoordinates(lat, lng) {
            // Fast, quiet fallback if reverse geocoding is slow or blocked
            const fallback = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1500); // 1.5s timeout
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
                const response = await fetch(url, { signal: controller.signal, headers: { 'Accept': 'application/json' } });
                clearTimeout(timeoutId);
                if (!response.ok) return fallback;
                const data = await response.json();
                return data && data.display_name ? data.display_name : fallback;
            } catch (_) {
                // Silently fall back to coordinates without spamming console
                return fallback;
            }
        }

        // Update location display with address and distance
        async function updateLocationDisplay(lat, lng, isUser = true) {
            const prefix = isUser ? 'user' : 'driver';
            
            // Update coordinates
            document.getElementById(`${prefix}Lat`).textContent = lat.toFixed(6);
            document.getElementById(`${prefix}Lng`).textContent = lng.toFixed(6);
            
            // Reverse geocode address (throttled to once per 10s per role)
            const now = Date.now();
            let address;
            if (now - lastGeocode[prefix].t > 10000) {
                address = await getAddressFromCoordinates(lat, lng);
                lastGeocode[prefix] = { t: now, addr: address };
                document.getElementById(`${prefix}AddressText`).textContent = address;
            } else if (lastGeocode[prefix].addr) {
                address = lastGeocode[prefix].addr;
                document.getElementById(`${prefix}AddressText`).textContent = lastGeocode[prefix].addr;
            } else {
                address = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                document.getElementById(`${prefix}AddressText`).textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            }
            
            // Calculate distance and direction only if both locations are available
            if (currentUserLocation && currentDriverLocation) {
                const otherLat = isUser ? currentDriverLocation.lat : currentUserLocation.lat;
                const otherLng = isUser ? currentDriverLocation.lng : currentUserLocation.lng;

                // Update direction (bearing) for UI
                const direction = calculateDirection(lat, lng, otherLat, otherLng);
                document.getElementById(`${prefix}Direction`).textContent = direction;

                // Use Google Directions route metrics for distance/ETA
                await updateRouteMetricsUI(prefix, { lat, lng }, { lat: otherLat, lng: otherLng }, false);

                // Use straight-line check for fine-grained proximity alerts (50m)
                const straightDistance = calculateDistance(lat, lng, otherLat, otherLng);
                if (straightDistance <= 0.05) {
                    document.getElementById(`${prefix}ProximityAlert`).style.display = 'block';
                    log(`${prefix}Log`, `🚨 PROXIMITY ALERT: Within 50 meters!`, 'warning');
                    if (isUser && !proximityOtpGenerated && !tripStarted) {
                        generateAutoOtp();
                        proximityOtpGenerated = true;
                    } else if (!isUser && !tripStarted) {
                        document.getElementById('driverOtpSection').style.display = 'block';
                    }
                } else {
                    document.getElementById(`${prefix}ProximityAlert`).style.display = 'none';
                }
            } else {
                // Hide distance info if both locations aren't available
                document.getElementById(`${prefix}DistanceInfo`).style.display = 'none';
                document.getElementById(`${prefix}ProximityAlert`).style.display = 'none';
                document.getElementById(`${prefix}Distance`).textContent = '--';
                document.getElementById(`${prefix}ETA`).textContent = '--';
            }
            
            return { distance: 0, direction: '--', address };
        }

        // WebSocket connection functions
        function connectUserWebSocket() {
            const userId = document.getElementById('userId').value;
            const rawUserBookingId = document.getElementById('userBookingId').value;
            const bookingId = (rawUserBookingId || '').trim();
            // write back trimmed value to input to avoid future mismatches
            document.getElementById('userBookingId').value = bookingId;
            
            if (!userId || !bookingId) {
                log('userLog', 'Please enter User ID and Booking ID', 'error');
                return;
            }

            const socket = new SockJS('/ws-trip-tracking');
            userStompClient = Stomp.over(socket);
            
            updateStatus('userStatus', 'connecting');
            log('userLog', 'Connecting to WebSocket...', 'info');

            userStompClient.connect({}, function(frame) {
                updateStatus('userStatus', 'connected');
                log('userLog', 'Connected to WebSocket!', 'success');

                // Subscribe to driver location updates
                userStompClient.subscribe(`/topic/booking/${bookingId}/driver-location`, function(message) {
                    const locationData = JSON.parse(message.body);
                    currentDriverLocation = { lat: locationData.latitude, lng: locationData.longitude };
                    if (currentUserLocation) {
                        updateLocationDisplay(currentUserLocation.lat, currentUserLocation.lng, true);
                        updateMapMarkers();
                    }
                    log('userLog', `Received driver location: ${locationData.latitude}, ${locationData.longitude}`, 'info');
                });

                // Subscribe to user notifications
                userStompClient.subscribe(`/topic/booking/${bookingId}/user-notifications`, function(message) {
                    const notification = JSON.parse(message.body);
                    handleUserNotification(notification);
                });

                log('userLog', `Subscribed to booking ${bookingId} channels`, 'success');
            }, function(error) {
                updateStatus('userStatus', 'disconnected');
                log('userLog', `WebSocket connection failed: ${error}`, 'error');
            });
        }

        function connectDriverWebSocket() {
            const driverId = document.getElementById('driverId').value;
            const rawDriverBookingId = document.getElementById('driverBookingId').value;
            const bookingId = (rawDriverBookingId || '').trim();
            // write back trimmed value to input to avoid future mismatches
            document.getElementById('driverBookingId').value = bookingId;
            
            if (!driverId || !bookingId) {
                log('driverLog', 'Please enter Driver ID and Booking ID', 'error');
                return;
            }

            const socket = new SockJS('/ws-trip-tracking');
            driverStompClient = Stomp.over(socket);
            
            updateStatus('driverStatus', 'connecting');
            log('driverLog', 'Connecting to WebSocket...', 'info');

            driverStompClient.connect({}, function(frame) {
                updateStatus('driverStatus', 'connected');
                log('driverLog', 'Connected to WebSocket!', 'success');

                // Subscribe to user location updates
                driverStompClient.subscribe(`/topic/booking/${bookingId}/user-location`, function(message) {
                    const locationData = JSON.parse(message.body);
                    currentUserLocation = { lat: locationData.latitude, lng: locationData.longitude };
                    if (currentDriverLocation) {
                        updateLocationDisplay(currentDriverLocation.lat, currentDriverLocation.lng, false);
                        updateMapMarkers();
                    }
                    log('driverLog', `Received user location: ${locationData.latitude}, ${locationData.longitude}`, 'info');
                });

                // Subscribe to driver notifications
                driverStompClient.subscribe(`/topic/booking/${bookingId}/driver-notifications`, function(message) {
                    const notification = JSON.parse(message.body);
                    handleDriverNotification(notification);
                });

                log('driverLog', `Subscribed to booking ${bookingId} channels`, 'success');
            }, function(error) {
                updateStatus('driverStatus', 'disconnected');
                log('driverLog', `WebSocket connection failed: ${error}`, 'error');
            });
        }

        // Location tracking functions
        async function startUserLocationTracking() {
            const startButton = document.querySelector('button[onclick="startUserLocationTracking()"]');
            try {
                if (userLocationInterval) {
                    log('userLog', 'Location tracking is already active.', 'warning');
                    return;
                }
                if (!userStompClient || !userStompClient.connected) {
                    log('userLog', 'Please connect to WebSocket first', 'error');
                    return;
                }
                startButton.disabled = true;
                startButton.textContent = 'Starting...';

                // Get initial location
                currentUserLocation = await getCurrentLocation();
                log('userLog', `Got current location: ${currentUserLocation.lat}, ${currentUserLocation.lng}`, 'success');

                userLocationInterval = setInterval(async () => {
                    try {
                        currentUserLocation = await getCurrentLocation();
                        const locationMessage = {
                            bookingId: document.getElementById('userBookingId').value,
                            userId: parseInt(document.getElementById('userId').value),
                            latitude: currentUserLocation.lat,
                            longitude: currentUserLocation.lng,
                            userType: 'USER',
                            timestamp: new Date().toISOString()
                        };
                        userStompClient.send('/app/user-location', {}, JSON.stringify(locationMessage));
                        await updateLocationDisplay(currentUserLocation.lat, currentUserLocation.lng, true);
                        updateMapMarkers();
                        log('userLog', `Location updated: ${currentUserLocation.lat.toFixed(6)}, ${currentUserLocation.lng.toFixed(6)}`, 'info');
                    } catch (error) {
                        log('userLog', `Failed to update location: ${error.message}`, 'error');
                    }
                }, 5000); // Update every 5 seconds

                log('userLog', 'Started location tracking with real GPS', 'success');
                startButton.textContent = 'Stop Location Tracking';
                startButton.onclick = stopUserLocationTracking;
            } catch (error) {
                log('userLog', `Error starting location tracking: ${error.message}`, 'error');
                startButton.disabled = false;
                startButton.textContent = 'Start Location Tracking';
            }
        }

        function stopUserLocationTracking() {
            const startButton = document.querySelector('button[onclick="stopUserLocationTracking()"], button[onclick="startUserLocationTracking()"]');
            if (userLocationInterval) {
                clearInterval(userLocationInterval);
                userLocationInterval = null;
                log('userLog', 'Stopped location tracking', 'warning');
                if(startButton){
                    startButton.disabled = false;
                    startButton.textContent = 'Start Location Tracking';
                    startButton.onclick = startUserLocationTracking;
                }
            }
        }

        async function startDriverLocationTracking() {
            const startButton = document.querySelector('button[onclick="startDriverLocationTracking()"]');
            try {
                if (driverLocationInterval) {
                    log('driverLog', 'Location tracking is already active.', 'warning');
                    return;
                }
                if (!driverStompClient || !driverStompClient.connected) {
                    log('driverLog', 'Please connect to WebSocket first', 'error');
                    return;
                }
                startButton.disabled = true;
                startButton.textContent = 'Starting...';

                currentDriverLocation = await getCurrentLocation();
                log('driverLog', `Got current location: ${currentDriverLocation.lat}, ${currentDriverLocation.lng}`, 'success');

                driverLocationInterval = setInterval(async () => {
                    try {
                        currentDriverLocation = await getCurrentLocation();
                        const locationMessage = {
                            bookingId: document.getElementById('driverBookingId').value,
                            driverId: parseInt(document.getElementById('driverId').value),
                            latitude: currentDriverLocation.lat,
                            longitude: currentDriverLocation.lng,
                            userType: 'DRIVER',
                            timestamp: new Date().toISOString()
                        };
                        driverStompClient.send('/app/driver-location', {}, JSON.stringify(locationMessage));
                        await updateLocationDisplay(currentDriverLocation.lat, currentDriverLocation.lng, false);
                        updateMapMarkers();
                        log('driverLog', `Location updated: ${currentDriverLocation.lat.toFixed(6)}, ${currentDriverLocation.lng.toFixed(6)}`, 'info');
                    } catch (error) {
                        log('driverLog', `Failed to update location: ${error.message}`, 'error');
                    }
                }, 5000); // Update every 5 seconds

                log('driverLog', 'Started location tracking with real GPS', 'success');
                startButton.textContent = 'Stop Location Tracking';
                startButton.onclick = stopDriverLocationTracking;
            } catch (error) {
                log('driverLog', `Error starting location tracking: ${error.message}`, 'error');
                startButton.disabled = false;
                startButton.textContent = 'Start Location Tracking';
            }
        }

        function stopDriverLocationTracking() {
            const startButton = document.querySelector('button[onclick="stopDriverLocationTracking()"], button[onclick="startDriverLocationTracking()"]');
            if (driverLocationInterval) {
                clearInterval(driverLocationInterval);
                driverLocationInterval = null;
                log('driverLog', 'Stopped location tracking', 'warning');
                if(startButton){
                    startButton.disabled = false;
                    startButton.textContent = 'Start Location Tracking';
                    startButton.onclick = startDriverLocationTracking;
                }
            }
        }

        // Booking creation functions
        function createBooking() {
            try {
                const pickup = document.getElementById('pickupLocation').value;
                const drop = document.getElementById('dropLocation').value;
                const date = document.getElementById('bookingDate').value;
                const time = document.getElementById('bookingTime').value;
                
                if (!pickup || !drop || !date || !time) {
                    log('userLog', 'Please fill all booking details', 'error');
                    return;
                }
                
                const bookingId = 'WTL' + Date.now();
                currentBookingId = bookingId;
                
                document.getElementById('generatedBookingId').textContent = bookingId;
                document.getElementById('displayPickup').textContent = pickup;
                document.getElementById('displayDrop').textContent = drop;
                document.getElementById('displayDateTime').textContent = `${date} ${time}`;
                document.getElementById('userBookingId').value = bookingId;
                
                document.getElementById('bookingSection').style.display = 'none';
                document.getElementById('bookingDisplay').style.display = 'block';
                
                log('userLog', `Booking created: ${bookingId}`, 'success');
            } catch (error) {
                log('userLog', `Error creating booking: ${error.message}`, 'error');
            }
        }
        
        function copyBookingId() {
            const bookingId = document.getElementById('generatedBookingId').textContent;
            navigator.clipboard.writeText(bookingId);
            log('userLog', 'Booking ID copied to clipboard', 'success');
        }
        
        // Auto OTP generation
        function generateAutoOtp() {
            currentOtp = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('autoGeneratedOtp').textContent = currentOtp;
            document.getElementById('autoOtpDisplay').style.display = 'block';
            document.getElementById('tripStatus').textContent = 'Driver nearby - OTP generated';
            
            log('userLog', `Auto OTP generated: ${currentOtp}`, 'success');
            
            // Send OTP to backend for storage
            if (userStompClient && userStompClient.connected) {
                const message = {
                    bookingId: (document.getElementById('userBookingId').value || '').trim(),
                    action: 'STORE_OTP',
                    otp: currentOtp,
                    driverId: parseInt(document.getElementById('driverId').value),
                    userId: parseInt(document.getElementById('userId').value)
                };
                userStompClient.send('/app/send-otp', {}, JSON.stringify(message));
            }
        }

        function verifyDriverOtp() {
            const otpInput = document.getElementById('driverOtpInput');
            const bookingIdRaw = document.getElementById('driverBookingId').value;
            const verifyBtn = document.querySelector('#driverOtpSection .btn');
            const otp = (otpInput.value || '').trim();
            const bookingId = (bookingIdRaw || '').trim();

            if (!otp || otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                log('driverLog', 'Please enter a valid 6-digit OTP.', 'error');
                return;
            }
            if (!bookingId) {
                log('driverLog', 'Booking ID missing. Please enter a valid Booking ID.', 'error');
                return;
            }

            if (!driverStompClient || !driverStompClient.connected) {
                log('driverLog', 'WebSocket not connected. Cannot verify OTP.', 'error');
                return;
            }

            log('driverLog', `Sending OTP ${otp} for verification...`, 'info');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            // Send via WebSocket including driverId and userId (some backends require these)
            driverStompClient.send('/app/verify-otp', {}, JSON.stringify({
                bookingId,
                otp,
                otpType: 'INITIAL',
                driverId: parseInt(document.getElementById('driverId').value),
                userId: parseInt(document.getElementById('userId').value)
            }));

            // Fallback after 8s if no server response over WS
            if (otpVerifyTimer) {
                clearTimeout(otpVerifyTimer);
            }
            otpVerifyTimer = setTimeout(async () => {
                log('driverLog', 'No WebSocket response. Falling back to REST for OTP verification...', 'warning');
                try {
                    const response = await fetch(`/api/bookings/verify-otp`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bookingId,
                            otp,
                            otpType: 'INITIAL'
                        })
                    });
                    if (response.ok) {
                        const result = await response.text();
                        log('driverLog', `OTP verified via REST: ${result}`, 'success');
                        document.getElementById('driverOtpSection').style.display = 'none';
                        document.getElementById('odometerSection').style.display = 'grid';
                    } else {
                        const errorText = await response.text();
                        log('driverLog', `OTP verification failed via REST: ${errorText || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    log('driverLog', `REST fallback error: ${err && err.message ? err.message : 'Network error'}`, 'error');
                } finally {
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify OTP & Start Trip';
                    otpVerifyTimer = null;
                }
            }, 8000);
        }

        async function startTripWithOdometer() {
            const startOdometerInput = document.getElementById('startOdometer');
            const bookingId = document.getElementById('driverBookingId').value;
            const startBtn = document.querySelector('#odometerSection .btn');
            const startOdometer = startOdometerInput.value;

            if (!startOdometer || isNaN(parseFloat(startOdometer))) {
                log('driverLog', 'Please enter a valid starting odometer reading.', 'error');
                return;
            }

            log('driverLog', `Starting trip with odometer: ${startOdometer}...`, 'info');
            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';

            try {
                const response = await fetch(`/api/bookings/start-trip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId, startOdometer: parseFloat(startOdometer) })
                });

                if (response.ok) {
                    const result = await response.text();
                    log('driverLog', `Trip started successfully: ${result}`, 'success');
                    document.getElementById('odometerSection').style.display = 'none';
                    document.getElementById('tripEndSection').style.display = 'block';
                    tripStarted = true;
                } else {
                    const errorText = await response.text();
                    log('driverLog', `Failed to start trip: ${errorText}`, 'error');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Confirm Start Trip';
                }
            } catch (error) {
                console.error('Error starting trip:', error);
                log('driverLog', 'An unexpected error occurred while starting the trip.', 'error');
                startBtn.disabled = false;
                startBtn.textContent = 'Confirm Start Trip';
            }
        }

        async function requestFinalOtp() {
            const endOdometerInput = document.getElementById('endOdometer');
            const bookingId = document.getElementById('driverBookingId').value;
            const requestBtn = document.querySelector('#tripEndSection .btn');
            const endOdometer = endOdometerInput.value;

            if (!endOdometer || isNaN(parseFloat(endOdometer))) {
                log('driverLog', 'Please enter a valid ending odometer reading.', 'error');
                return;
            }

            log('driverLog', 'Requesting final OTP...', 'info');
            requestBtn.disabled = true;
            requestBtn.textContent = 'Requesting...';

            try {
                const response = await fetch(`/api/bookings/request-final-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId, endOdometer: parseFloat(endOdometer) })
                });

                if (response.ok) {
                    const result = await response.text();
                    log('driverLog', `Final OTP requested successfully: ${result}`, 'success');
                    document.getElementById('tripEndSection').style.display = 'none';
                    document.getElementById('driverFinalOtpSection').style.display = 'block';
                } else {
                    const errorText = await response.text();
                    log('driverLog', `Failed to request final OTP: ${errorText}`, 'error');
                    requestBtn.disabled = false;
                    requestBtn.textContent = 'Request Final OTP';
                }
            } catch (error) {
                console.error('Error requesting final OTP:', error);
                log('driverLog', 'An unexpected error occurred while requesting the final OTP.', 'error');
                requestBtn.disabled = false;
                requestBtn.textContent = 'Request Final OTP';
            }
        }

        function verifyFinalOtp() {
            const finalOtpInput = document.getElementById('driverFinalOtpInput');
            const bookingIdRaw = document.getElementById('driverBookingId').value;
            const endBtn = document.querySelector('#driverFinalOtpSection .btn');
            const finalOtp = (finalOtpInput.value || '').trim();
            const bookingId = (bookingIdRaw || '').trim();

            if (!finalOtp || finalOtp.length !== 6 || !/^\d{6}$/.test(finalOtp)) {
                log('driverLog', 'Please enter a valid 6-digit final OTP.', 'error');
                return;
            }
            if (!bookingId) {
                log('driverLog', 'Booking ID missing. Please enter a valid Booking ID.', 'error');
                return;
            }

            if (!driverStompClient || !driverStompClient.connected) {
                log('driverLog', 'WebSocket not connected. Falling back to REST for final OTP verification...', 'warning');
                return verifyFinalOtpViaRest(bookingId, finalOtp, endBtn);
            }

            log('driverLog', `Sending final OTP ${finalOtp} for verification...`, 'info');
            endBtn.disabled = true;
            endBtn.textContent = 'Verifying...';

            // Send over WebSocket first
            driverStompClient.send('/app/verify-otp', {}, JSON.stringify({
                bookingId,
                otp: finalOtp,
                otpType: 'FINAL',
                driverId: parseInt(document.getElementById('driverId').value),
                userId: parseInt(document.getElementById('userId').value)
            }));

            // Fallback after 8s if no server response over WS
            if (finalOtpVerifyTimer) {
                clearTimeout(finalOtpVerifyTimer);
            }
            finalOtpVerifyTimer = setTimeout(() => {
                log('driverLog', 'No WebSocket response. Falling back to REST for final OTP verification...', 'warning');
                verifyFinalOtpViaRest(bookingId, finalOtp, endBtn);
            }, 8000);
        }

        async function verifyFinalOtpViaRest(bookingId, finalOtp, endBtn) {
            try {
                const response = await fetch(`/api/bookings/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId, otp: finalOtp, otpType: 'FINAL' })
                });

                if (response.ok) {
                    const result = await response.text();
                    log('driverLog', `Final OTP verified via REST: ${result}`, 'success');
                    document.getElementById('driverFinalOtpSection').style.display = 'none';
                    resetDriverPanel();
                } else {
                    const errorText = await response.text();
                    log('driverLog', `Final OTP verification failed via REST: ${errorText || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log('driverLog', `REST fallback error (final OTP): ${error && error.message ? error.message : 'Network error'}`, 'error');
            } finally {
                if (endBtn) {
                    endBtn.disabled = false;
                    endBtn.textContent = 'Verify Final OTP & End Trip';
                }
                if (finalOtpVerifyTimer) { clearTimeout(finalOtpVerifyTimer); finalOtpVerifyTimer = null; }
            }
        }

        function verifyUserOtp() {
            // This function is primarily for user-side verification if needed, currently unused in the main flow.
        }


        // Generate final OTP for trip end
        function generateFinalOtp() {
            finalOtp = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('finalGeneratedOtp').textContent = finalOtp;
            document.getElementById('finalOtpDisplay').style.display = 'block';
            document.getElementById('tripStatus').textContent = 'Trip ending - Final OTP generated';
            
            log('userLog', `Final OTP generated: ${finalOtp}`, 'success');
            
            // Send final OTP to backend for storage
            if (userStompClient && userStompClient.connected) {
                const message = {
                    bookingId: document.getElementById('userBookingId').value,
                    action: 'STORE_FINAL_OTP',
                    otp: finalOtp,
                    driverId: parseInt(document.getElementById('driverId').value),
                    userId: parseInt(document.getElementById('userId').value)
                };
                userStompClient.send('/app/send-otp', {}, JSON.stringify(message));
            }
        }

        // Notification handlers
        function handleUserNotification(notification) {
            log('userLog', `Notification: ${notification.action}`, 'info');
            
            if (notification.action === 'OTP_SENT') {
                document.getElementById('userOtpSection').style.display = 'block';
                log('userLog', `OTP received: ${notification.otp}`, 'success');
            } else if (notification.action === 'AUTO_OTP_GENERATED') {
                // Handle automatic OTP generation from backend
                currentOtp = notification.otp;
                document.getElementById('autoGeneratedOtp').textContent = currentOtp;
                document.getElementById('autoOtpDisplay').style.display = 'block';
                document.getElementById('tripStatus').textContent = 'Driver nearby - OTP generated';
                log('userLog', `Auto OTP generated by system: ${currentOtp}`, 'success');
                proximityOtpGenerated = true;
            } else if (notification.action === 'DRIVER_ARRIVED') {
                log('userLog', 'Driver has arrived! Please verify OTP', 'success');
                document.getElementById('tripStatus').textContent = 'Driver arrived - Ready for pickup';
            } else if (notification.action === 'TRIP_STARTED') {
                log('userLog', 'Trip has started!', 'success');
                document.getElementById('tripStatus').textContent = 'Trip in progress';
                document.getElementById('autoOtpDisplay').style.display = 'none';
                tripStarted = true;
            } else if (notification.action === 'TRIP_ENDED') {
                log('userLog', 'Trip has ended!', 'success');
                document.getElementById('tripStatus').textContent = 'Trip completed';
                document.getElementById('finalOtpDisplay').style.display = 'none';
            } else if (notification.action === 'REQUEST_FINAL_OTP') {
                log('userLog', 'Driver requesting final OTP for trip end', 'info');
                generateFinalOtp();
            }
        }

        function handleDriverNotification(notification) {
            const action = notification && notification.action ? notification.action : 'UNKNOWN';
            const msg = notification && (notification.message || notification.reason || notification.error) ? (notification.message || notification.reason || notification.error) : '';
            log('driverLog', `Notification received: ${action}${msg ? ' - ' + msg : ''}`, 'info');
            const verifyBtn = document.querySelector('#driverOtpSection .btn');
            const finalVerifyBtn = document.querySelector('#driverFinalOtpSection .btn');

            switch (action) {
                case 'OTP_VERIFIED':
                    log('driverLog', 'Initial OTP verified successfully!', 'success');
                    document.getElementById('driverOtpSection').style.display = 'none';
                    document.getElementById('odometerSection').style.display = 'grid';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify OTP & Start Trip';
                    if (otpVerifyTimer) { clearTimeout(otpVerifyTimer); otpVerifyTimer = null; }
                    break;
                case 'OTP_INVALID':
                    log('driverLog', `OTP verification failed${msg ? ': ' + msg : ''}`, 'error');
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify OTP & Start Trip';
                    if (otpVerifyTimer) { clearTimeout(otpVerifyTimer); otpVerifyTimer = null; }
                    break;
                case 'FINAL_OTP_VERIFIED':
                    log('driverLog', 'Final OTP verified. Trip ended successfully!', 'success');
                    document.getElementById('driverFinalOtpSection').style.display = 'none';
                    if (finalOtpVerifyTimer) { clearTimeout(finalOtpVerifyTimer); finalOtpVerifyTimer = null; }
                    resetDriverPanel();
                    break;
                case 'FINAL_OTP_INVALID':
                    log('driverLog', `Final OTP verification failed${msg ? ': ' + msg : ''}`, 'error');
                    finalVerifyBtn.disabled = false;
                    finalVerifyBtn.textContent = 'Verify Final OTP & End Trip';
                    if (finalOtpVerifyTimer) { clearTimeout(finalOtpVerifyTimer); finalOtpVerifyTimer = null; }
                    break;
                case 'TRIP_STARTED':
                    log('driverLog', 'Trip started successfully!', 'success');
                    document.getElementById('odometerSection').style.display = 'none';
                    document.getElementById('tripEndSection').style.display = 'block';
                    tripStarted = true;
                    break;
                case 'TRIP_ENDED':
                    log('driverLog', 'Trip ended successfully!', 'success');
                    resetDriverPanel();
                    break;
                case 'NEAR_USER':
                    log('driverLog', 'You are near the user. Please ask for OTP.', 'success');
                    document.getElementById('driverProximityAlert').style.display = 'block';
                    document.getElementById('driverOtpSection').style.display = 'block';
                    break;
                default:
                    log('driverLog', `Unknown notification action: ${action}`, 'warning');
            }
        }


        // Utility functions
        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
        }

        function resetDriverPanel() {
            log('driverLog', 'Resetting driver panel for new trip.', 'info');
            // Hide all conditional sections
            document.getElementById('driverOtpSection').style.display = 'none';
            document.getElementById('odometerSection').style.display = 'none';
            document.getElementById('tripEndSection').style.display = 'none';
            document.getElementById('driverFinalOtpSection').style.display = 'none';
            document.getElementById('driverProximityAlert').style.display = 'none';

            // Reset input fields
            document.getElementById('driverOtpInput').value = '';
            document.getElementById('startOdometer').value = '';
            document.getElementById('endOdometer').value = '';
            document.getElementById('driverFinalOtpInput').value = '';

            // Reset buttons to their initial state
            const verifyBtn = document.querySelector('#driverOtpSection .btn');
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify OTP & Start Trip';

            const startBtn = document.querySelector('#odometerSection .btn');
            startBtn.disabled = false;
            startBtn.textContent = 'Confirm Start Trip';

            const requestBtn = document.querySelector('#tripEndSection .btn');
            requestBtn.disabled = false;
            requestBtn.textContent = 'Request Final OTP';

            const endBtn = document.querySelector('#driverFinalOtpSection .btn');
            endBtn.disabled = false;
            endBtn.textContent = 'Verify Final OTP & End Trip';

            // Reset state variables
            tripStarted = false;
            proximityOtpGenerated = false;
        }

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        // Initialize Google Maps
        function initMap() {
            // Initialize map with default location (Pune)
            const defaultLocation = { lat: 18.5204, lng: 73.8567 };
            
            map = new google.maps.Map(document.getElementById('googleMap'), {
                zoom: 15,
                center: defaultLocation,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Initialize services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#667eea',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            directionsRenderer.setMap(map);

            // Initialize traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            
            // Create custom markers
            createMarkers();
            
            log('userLog', 'Google Maps initialized', 'success');
            log('driverLog', 'Google Maps initialized', 'success');
        }

        // Create custom markers for user and driver
        function createMarkers() {
            // User marker (red circle like Ola/Uber)
            userMarker = new google.maps.Marker({
                position: { lat: 18.5204, lng: 73.8567 },
                map: map,
                title: 'User Location',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#dc3545',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                },
                zIndex: 1000
            });

            // Driver marker (blue car icon)
            driverMarker = new google.maps.Marker({
                position: { lat: 18.5204, lng: 73.8567 },
                map: map,
                title: 'Driver Location',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#007bff',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                },
                zIndex: 1001
            });
        }

        // Update markers on map
        async function updateMapMarkers() {
            if (currentUserLocation && userMarker) {
                userMarker.setPosition(currentUserLocation);
            }
            if (currentDriverLocation && driverMarker) {
                driverMarker.setPosition(currentDriverLocation);
            }
            
            // Update map info
            if (currentUserLocation && currentDriverLocation) {
                try {
                    const { distanceKm, durationMin, result } = await getRouteMetrics(currentUserLocation, currentDriverLocation);
                    if (directionsRenderer && result) {
                        directionsRenderer.setDirections(result);
                    }
                    const direction = calculateDirection(
                        currentUserLocation.lat, currentUserLocation.lng,
                        currentDriverLocation.lat, currentDriverLocation.lng
                    );
                    if (typeof distanceKm === 'number') {
                        document.getElementById('mapDistance').textContent = `${distanceKm.toFixed(2)} km`;
                    }
                    if (typeof durationMin === 'number') {
                        document.getElementById('mapETA').textContent = `${durationMin} min`;
                    }
                    document.getElementById('mapDirection').textContent = direction;
                    document.getElementById('mapStatus').textContent = 'Live tracking active';
                } catch (e) {
                    // Fallback to straight-line if Directions fails
                    const distance = calculateDistance(
                        currentUserLocation.lat, currentUserLocation.lng,
                        currentDriverLocation.lat, currentDriverLocation.lng
                    );
                    const direction = calculateDirection(
                        currentUserLocation.lat, currentUserLocation.lng,
                        currentDriverLocation.lat, currentDriverLocation.lng
                    );
                    const eta = Math.round(distance * 2);
                    document.getElementById('mapDistance').textContent = `${distance.toFixed(2)} km`;
                    document.getElementById('mapETA').textContent = `${eta} min`;
                    document.getElementById('mapDirection').textContent = direction;
                    document.getElementById('mapStatus').textContent = 'Live tracking active (fallback)';
                }
            }
        }

        // Center map on both markers
        function centerMap() {
            if (currentUserLocation && currentDriverLocation) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(currentUserLocation);
                bounds.extend(currentDriverLocation);
                map.fitBounds(bounds);
            }
        }

        // Toggle traffic layer
        function toggleTraffic() {
            if (isTrafficVisible) {
                trafficLayer.setMap(null);
                isTrafficVisible = false;
            } else {
                trafficLayer.setMap(map);
                isTrafficVisible = true;
            }
        }

        // Show route between user and driver
        function showRoute() {
            if (!currentUserLocation || !currentDriverLocation) {
                alert('Both user and driver locations are required');
                return;
            }

            const request = {
                origin: currentUserLocation,
                destination: currentDriverLocation,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                }
            });
        }

        // Initialize status indicators and get initial location
        document.addEventListener('DOMContentLoaded', async function() {
            updateStatus('userStatus', 'disconnected');
            updateStatus('driverStatus', 'disconnected');
            
            // Set default date and time for booking
            const today = new Date();
            document.getElementById('bookingDate').value = today.toISOString().split('T')[0];
            document.getElementById('bookingTime').value = today.toTimeString().slice(0, 5);
            
            // Initialize Google Maps
            initMap();
            
            // Get initial locations for both user and driver
            try {
                currentUserLocation = await getCurrentLocation();
                currentDriverLocation = await getCurrentLocation();
                
                // Initialize location displays
                await updateLocationDisplay(currentUserLocation.lat, currentUserLocation.lng, true);
                await updateLocationDisplay(currentDriverLocation.lat, currentDriverLocation.lng, false);
                
                // Update map markers
                updateMapMarkers();
                
                log('userLog', 'User panel ready with real GPS location and Google Maps', 'success');
                log('driverLog', 'Driver panel ready with real GPS location and Google Maps', 'success');
            } catch (error) {
                log('userLog', `Error getting initial location: ${error.message}`, 'error');
                log('driverLog', `Error getting initial location: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
